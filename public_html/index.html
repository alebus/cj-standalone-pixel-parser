<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Standalone pixel parser</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                
        <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

        <link rel="stylesheet" type="text/css" href="pixelparser.css">

        <link rel="icon" type="image/png" href="favicon1.png">

    
    </head>
<body>
        
        
<img height="100" src="cj_logo.png">
<img height="95" src="pixel_parser_airstream.png">
<br><br>



<input class="a_textbox" type="text" size="150" id="a_input"><br>
<input class="a_button" type="submit" value="Parse the pixel" id="a_submit">
<div id="output_area"></div>
<br/><br/><br/>


<table >
    <tr><td>sample pixel for testing:</td><td>&nbsp;</td><td>broken pixel for testing:</td></tr>
<tr>
    <td>
        <textarea class="sample_pixel" rows="4" cols="50">OID=123ABC&CID=151515&TYPE=353241&containerTagId=777&DCNT5=27.25&DCNT4=9.75&DCNT3=14.75&DCNT2=8.50&DCNT1=9.50&QTY5=1&DISCOUNT=5.00&QTY4=1&QTY3=1&AMT5=109.00&QTY2=1&AMT4=39.00&QTY1=2&AMT3=59.00&ITEM5=444234&AMT2=34.00&ITEM4=442843_BLA_L_1&AMT1=19.00&CURRENCY=USD&ITEM3=444685&ITEM2=404511&ITEM1=384275&COUPON=MUSHROOM_PIXXA</textarea>
    </td>
    <td>&nbsp;</td>
    <td>
        <textarea class="broken_pixel" rows="4" cols="50">OID=123ABC&CID=151515&TYPE=353241&containerTagId=777&DCNTx=27.25&DCNT4=-9.75&DCNT3=$14.75&DCNT2=8.50&DCNT1=9..50&QTY5=1&DISCOUNT=-5.00&QTY4=1.0&QTY3=-1&AMT5=109..00&QTY2=1&AMT4=39,00&QTY1=2&AMT3=$59.00&ITEM5=444234&AMT2=34.00&ITEM4=44284.3_BLA_L_1&AMT1=19.00&CURRENCY=USD&ITEM3=444685&ITEM2=404#511&ITEM1=384275&COUPON=MUSHROOM_PIXXA</textarea>
    </td>
</tr>
</table>

<br><br>
<div class="infoblue">
<strong>NEW FEATURES</strong>
<ul>

    <li><strong>Update 03-25-2016: Some internal and final values in this tool are now rounded to TWO decimal places. The pixel parser and CJ system may not calculate subtotals in the same way.</strong></li>   
	<li><strong>Error-checking is being added</strong></li>    
	<li>Now supports HTML-encoded ampersands</li>
	
    <ul>
        <li>Currently implemented:</li>
            <li>QTY: Non-numeric values</li>
            <li>ITEM: Any character besides dashes, underscores, and alphanumeric</li>
            <li>AMOUNT and ITEM in the same tag (simple and advanced combined)</li>
            <li>Checks AMT and AMOUNT for anything besides 0-9 with decimal.</li>
            <li>Also runs separate "is numeric" check on AMT and AMOUNT in contains "1..0 " or similar.</li>
            <li>Warn if COUPON is missing</li>
            <li>A literal DCNTx etc. However, some variations currently break the parser.</li>
        </ul>
    
    
</ul>


<strong>Notes and warnings:</strong>
<ul>
<li>Recommended browser: Chrome</li>
<li>Some kinds of tags may break the parser - it requires properly formed key/value pairs and other basic information to be correct in order to parse the query string.</li>
<li>Characters displayed in warnings will be separated with commas.</li>
<li>Currently only "known" parameters are listed.</li>
<li>You should always verify the tag manually as well.</li>
<li>Please let Airn know if you find any bugs.<img src="bug.png"></li>
</ul>
</div>

<br><br>
<p>-- Version 1.6 -- </p>



<script>

/*
 *Standalone Pixel Parser 
 *By Airn LeBus
 *TODO: general TODO and NOTES moved out into separate file 05-07-2015 
 * 
 * 
*/


$("#output_area").toggle();

$("#a_submit").click(

	function(e){		
			
        //clear the div before adding output
        $("#output_area").html("");
			
           
	var querystring = $("#a_input").val();
        
        
        //the regex can't have quotes around it
        querystring = querystring.replace(/&amp;/gi,'&');      
        	
        var subTotal = 0;
		
        
        //if you set this to true, later will warn user about the subtotal
        var badSubtotal = false;
	//TODO - finish implemetning this in all valid places
        
        
        //note if you change this: there is a test for this exact string later
        var warnings = "<div class='warnings'>";
		
			
        //parse pixel
        
        
        var pixelArray = querystring.split("&");
        var pixelDict = new Array();
        
        
        //05-06-2015 original code used "for...in" lopp but am changing to use a for loop based on array length per apparent best practices 
        for(i = 0; i < pixelArray.length; i++){
      
            
            //TODO valdiate that the pixel is correct before chopping it like this
            //and throw warnings, maybe even stop executing at that point
            //**branch the code before you start working on that, 
            //since may require major changes to the structure of the code
            //also note the for loop which goes through the ITEMs and stops when one is not found
            
            //look for AMTx etc
            //TODO do some changes to param names break parsing?
            //if the whole concept is to loop through ITEMx, that part needs to be correct
            //you could at least verify that's correct, and then later check the QTY and AMT
            usingX = pixelArray[i].match(/(dcntx)|(amtx)|(itemx)|(qtyx)/gi);
            if(usingX != null){
                    warnings += '<br/>Warning: found bad parameter: ' + usingX;
                }
            
            var t = pixelArray[i].split("=");
            pixelDict[t[0].toUpperCase()] = t[1];
                
            
        }
			
            var itemList = "";
            var qtyBadChars = "";
            var itemBadChars = "";
            var amountBadChars = "";
            var amtBadChars = "";
            
            
            //store if we think tag is simple or item, etc
            var tagType = "";
            
            if(pixelDict["AMOUNT"] != undefined){
                
                amountBadChars = pixelDict["AMOUNT"].match(/[^0-9\.]/g);
                if(amountBadChars != null){
                    warnings += '<br/>Warning: Illegal characters found in AMOUNT: ' + amountBadChars;
                    badSubtotal = true;
                }
                
                if( ! $.isNumeric(pixelDict["AMOUNT"])) {
                    
                    warnings += '<br/>Warning: AMOUNT is not a numeric value: ' + pixelDict["AMOUNT"];
                    badSubtotal = true;
                }
                
                tagType = "simple";
		itemList = itemList + '<span class="params">AMOUNT</span>: ' + pixelDict["AMOUNT"]+'<br/>';
		subTotal = subTotal + Math.round(parseFloat(pixelDict["AMOUNT"])* 100) / 100;
            }
				
				
            if(pixelDict["CONTAINERTAGID"] != undefined){
		itemList = itemList + '<span class="params">CONTAINERTAGID</span>: ' + pixelDict["CONTAINERTAGID"]+'<br/>';
            }
				
            //show warning if coupon is missing
            if(pixelDict["COUPON"] == undefined){
                  warnings += '<br/>Warning: COUPON is missing.';
            };
            
            
            if(pixelDict["COUPON"] != undefined){
		itemList = itemList + '<span class="params">COUPON</span>: ' + pixelDict["COUPON"]+'<br/>';
            }
				
            if(pixelDict["CURRENCY"] != undefined){
            itemList = itemList + '<span class="params">CURRENCY</span>: ' + pixelDict["CURRENCY"]+'<br/>';
            }
					
				
            if(pixelDict["DISCOUNT"] != undefined){
            itemList = itemList + '<span class="params">DISCOUNT</span>: ' + pixelDict["DISCOUNT"]+'<br/>';
            
                      
            subTotal = subTotal - Math.round(parseFloat(pixelDict["DISCOUNT"]) * 100) / 100;
            }
			
            itemList = itemList + '<img src="blue_line.png">';
			
			
            for(var n = 1; n < 100 + 1; n++){
				
            if(pixelDict["ITEM"+n] != undefined){
                
                //TODO add checks for all the other item-style params too
                //TODO BUG this is output too many times
                if(tagType == "simple"){
                    warnings += '<br/>Warning: tag has both AMOUNT and ITEM params';
                    warnings += '<br/>The subtotal will not be calculated for this reason.';
                    badSubtotal = true;
                }
                
                //TODO - check ITEM+n, AMT+n, and QTY+n for the following:
                //does another one exist like two AMT1? that would need to be further up in the flow
                //does the value previous exist, i.e. for ATM2, does AMT1 exist?
                //for AMT1, AMT0 should NOT exist :>
       
                
                //match anything that is not dash, underscore, alphanumeric
                itemBadChars = pixelDict["ITEM"+n].match(/[^0-9A-Z\-_]/gi);

                if(itemBadChars != null){
                    warnings += '<br/>Warning: Illegal characters found in ITEM'+n+': ' + itemBadChars;
                }
                
                
                itemList = itemList + '<br/>'+
                 '<span class="params_head">SKU GROUP NUMBER: '+n +'</span><br/>'+
                 '<span class="params">ITEM'+'</span>: ' + pixelDict["ITEM"+n]+'<br/>'+
                 '<span class="params">AMT'+'</span>: ' + pixelDict["AMT"+n] +'<br/>'+
                 '<span class="params">QTY'+'</span>: ' + pixelDict["QTY"+n] +'<br/>';

              
                //match anything that is not a number
                qtyBadChars = pixelDict["QTY"+n].match(/[^0-9]/g);

                if(qtyBadChars != null){
                    warnings += '<br/>Warning: Illegal characters found in QTY'+n+': ' + qtyBadChars;
                    badSubtotal = true;
                }
	
                tempamt = Math.round( parseFloat(pixelDict["AMT"+n]) * 100) / 100;
                tempqty = Math.round( parseFloat(pixelDict["QTY"+n]) * 100) / 100;
                
		subTotal = subTotal + (tempamt * tempqty) ;
		
                amtBadChars = pixelDict["AMT"+n].match(/[^0-9\.]/g);
                if(amtBadChars != null){
                    warnings += '<br/>Warning: Illegal characters found in AMT'+n+': ' + amtBadChars;
                    badSubtotal = true;
                }
                
                if( ! $.isNumeric(pixelDict["AMT"+n])) {
                    
                    warnings += '<br/>Warning: AMT'+n+' is not a numeric value: ' + pixelDict["AMT"+n];
                    badSubtotal = true;
                }
                
                
         	if(pixelDict["DCNT"+n] != undefined){
                    itemList = itemList + '<span class="params">DCNT</span>: ' + pixelDict["DCNT"+n]+'<br/>';
                    
                                      
                    subTotal = subTotal - Math.round( parseFloat(pixelDict["DCNT"+n]) * 100) / 100;
		}
            }   else { 	
                
                    //TODO this is meant to stop normally when the array ends, 
                    //but note that it will stop if there is any break in the ITEMx consequtive order
            
                    break; }
			
            }
			
			
            //show a warning if the subtoal is suspect
            if(badSubtotal === true){
                                
                warnings += '<br>Warning: Fields used in the order subtotal generated errors. The subtotal may be incorrect.';
            }
            
            //close the warnings div
            warnings += "<br/><br/></div><br/><br/>";
            
            //TODO update this if you change the warnings section
            //hide the warnings area if nothing was added
            if(warnings === "<div class='warnings'><br/><br/></div><br/><br/>"){
                
                warnings = "";
            }
            
            
				subTotal = Math.round(subTotal * 100) / 100;

				
                //TODO check final HTML output for validity, there are a lot of randon DIVs etc
                $("#output_area").append('<br>' + warnings
                    +'<strong>SUBTOTAL: ' + subTotal + '</strong><br/><br/>'
                    +'<span class="params">CID</span>: ' + pixelDict["CID"] + '<br/>' 
                    +'<span class="params">TYPE</span>: ' + pixelDict["TYPE"] + '<br/>'
                    +'<span class="params">OID</span>: '+ pixelDict["OID"] + '<br/>'
                    + itemList 
                    +'</div></div><img src="blue_line.png">');


                //only toggle the area if it's hidden already, otherwise it gets hidden 
                if( $( "#output_area" ).is( ":hidden" ) ) {
                    
                    $( "#output_area" ).toggle( "slide","500" );    
                    
                }
                

                
														  
                //old - used for popup
                //$(".pop").css("top", e.pageY).css("left", e.pageX - $(".pop").width());
                //$(".pop").slideFadeToggle();
                //$(".pop").draggable({ cancel: "div.info" });	


                //TODO - is it best practice to have this? was in old version
                //return false;
                
		}
);


//this is from when the code was delivered in a popup
/*
    $(function() {
        $(".close").live('click', function() {
            $(".pop").slideFadeToggle();
            $(".messagepop").remove();
            return false;
        });
    });

    $.fn.slideFadeToggle = function(easing, callback) {
        return this.animate({ opacity: 'toggle', height: 'toggle' }, "fast", easing, callback);
};
*/	
</script>



</body>

</html>
   





