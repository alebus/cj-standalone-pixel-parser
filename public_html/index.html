<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Standalone pixel parser</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                
        <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>

        <link rel="stylesheet" type="text/css" href="pixelparser.css">

        <link rel="icon" type="image/png" href="favicon1.png">

    
    </head>
<body>
        
        
<img height="125" src="pixel_mario.png">
<img src="pixel_parser.png">
<br><br>

<p>-- Version 1.4 -- </p>
<br><br>

<input action=# method="get" type="text" size="150" id="a_input">
<input type="submit" value="Parse the pixel" id="a_submit">
<div id="output_area"></div>
<br>


<p>sample pixel for testing:</p>
<textarea class="sample_pixel" rows="4" cols="100">OID=123ABC&CID=151515&TYPE=353241&containerTagId=777&DCNT5=27.25&DCNT4=9.75&DCNT3=14.75&DCNT2=8.50&DCNT1=9.50&QTY5=1&DISCOUNT=5.00&QTY4=1&QTY3=1&AMT5=109.00&QTY2=1&AMT4=39.00&QTY1=2&AMT3=59.00&ITEM5=444234&AMT2=34.00&ITEM4=442843_BLA_L_1&AMT1=19.00&CURRENCY=USD&ITEM3=444685&ITEM2=404511&ITEM1=384275&COUPON=MUSHROOM_PIXXA</textarea>

<p>broken pixel for testing:</p>
<textarea class="broken_pixel" rows="4" cols="100">OID=123ABC&CID=151515&TYPE=353241&containerTagId=777&DCNTx=27.25&DCNT4=9.75&DCNT3=$14.75&DCNT2=8.50&DCNT1=9.50&QTY5=1&DISCOUNT=5.00&QTY4=1.0&QTY3=-1&AMT5=109.00&QTY2=1&AMT4=39.00&QTY1=2&AMT3=59.00&ITEM5=444234&AMT2=34.00&ITEM4=44284.3_BLA_L_1&AMT1=19.00&CURRENCY=USD&ITEM3=444685&ITEM2=404#511&ITEM1=384275&COUPON=MUSHROOM_PIXXA</textarea>


<br><br><hr>
<p>NEW: now supports encoded ampersands (&amp;amp;)</p>
<p>NEW: error-checking is now being added. Here is a list of what the parser will currently check for:</p>
<ul>
    <li>QTY: Non-numeric values</li>
    <li>ITEM: Any character besides dashes, underscores, and alphanumeric</li>
    <li>AMOUNT and ITEM in the same tag (simple and advanced combined)</li>
    <li>A literal DCNTx etc. However, some variations currently break the parser.</li>
</ul>
Notes and warnings:<br/>
<i>Some kinds of tags may break the parser - it requires properly formed key/value pairs and other basic information to be correct in order to parse the query string<br></i>
<i>Characters displayed in warnings will be separated with commas.<br></i>
<i>Currently only "known" parameters are listed. You should always verify the tag manually as well.<br></i>
<i>You should always verify the tag manually as well.<br></i>
<br>





<script>

//By Airn LeBus
//Version: 1.2: major updates to HTML and output format, plus a move to shell1 from allied
//Version: 1.3: move into netbeans, move to github, etc etc
//05-05-2015 I removed popup which included changing the CSS
//version 1.4: 05-05-2015 and 05-06-2015: tons of changes to add various error checking, etc etc etc
//also supports encoded ampersands now, changed for loop structure, etc etc
//
//TODO how best keep track of version numbers? or don't?
//
//TODO do you need to escape input etc? esp if something located on external server, I don't want them doing XSS attacks etc
//JS/jQuery book has some great info on that 
//
//TODO before release to everyone, push to a test_version file and have some people start using it
//
//*TODO you could have it display every param that is NOT in a list of known params
//
//TODO see notes in Onenote
//TODO is there a way to put comments in a separate private file etc? or just make a TODO file and don't push that to production
//or branch it and remove all comments and push that one to the server
//
//TODO sometime closing the window redirects the browser

//TODO remove comments before push to production
//
//TODO - parse &amp; too
//
//TODO update to match kibana version as needed but remember that a lot of this works differently 


//TODO do these next: 
//*Per jen: amtx or other wrong things
//DONE *per jen: chars other than dashes/underscores, a-z and 0-9 in SKUs

//TODO soon - check for anything besides decimal and numbers in AMT / AMOUNT 



$("#output_area").toggle();

$("#a_submit").click(

	function(e){		
			
        //clear the div before adding output
        $("#output_area").html("");
			
        
	var querystring = $("#a_input").val();
        
        
        //the regex can't have quotes around it, I confirmed this with tests
        //it does NOT work to do it this way:
        //regex = "/test/gi";
        querystring = querystring.replace(/&amp;/gi,'&');      
        //console.log(querystring);
	
        var subTotal = "0";
        
        //if you set this to true, later it will warn you about the subtotal
        var badSubtotal = false;
	//TODO - finish implemetning this in all valid places
        
        
        var warnings = "<div class='warnings'>";
		
			
        //parse pixel
        
        //TODO check to see if the pixel uses &amp; and just replace them with ampersands,
        //then add a note that it was done
        
        var pixelArray = querystring.split("&");
        var pixelDict = new Array();
        
        
        //05-06-2015 original code used "for...in" lopp but am changing to use a for loop based on array length per apparent best practices 
        for(i = 0; i < pixelArray.length; i++){
      
            
            //TODO valdiate that the pixel is correct before chopping it like this
            //and throw warnings, maybe even stop executing at that point
            //**branch the code before you start working on that, 
            //since may require major changes to the structure of the code
            //also note the for loop which goes through the ITEMs and stops when one is not found
            
            //look for AMTx etc
            //TODO do some changes to param names break parsing?
            //if the whole concept is to loop through ITEMx, that part needs to be correct
            //you could at least verify that's correct, and then later check the QTY and AMT
            usingX = pixelArray[i].match(/(dcntx)|(amtx)|(itemx)|(qtyx)/gi);
            if(usingX != null){
                    warnings += '<br/>Warning: found bad parameter: ' + usingX;
                }
            
            var t = pixelArray[i].split("=");
            pixelDict[t[0].toUpperCase()] = t[1];
                
            
        }
			
            var itemList = "";
            var qtyBadChars = "";
            var itemBadChars = "";
            
            
            //store if we think tag is simple or item, etc
            var tagType = "";
            
            if(pixelDict["AMOUNT"] != undefined){
                
                tagType = "simple";
		itemList = itemList + '<span class="params">AMOUNT</span>: ' + pixelDict["AMOUNT"]+'<br/>';
		subTotal = subTotal + parseFloat(pixelDict["AMOUNT"]);
            }
				
				
            if(pixelDict["CONTAINERTAGID"] != undefined){
		itemList = itemList + '<span class="params">CONTAINERTAGID</span>: ' + pixelDict["CONTAINERTAGID"]+'<br/>';
            }
				
			
            if(pixelDict["COUPON"] != undefined){
		itemList = itemList + '<span class="params">COUPON</span>: ' + pixelDict["COUPON"]+'<br/>';
            }
				
            if(pixelDict["CURRENCY"] != undefined){
            itemList = itemList + '<span class="params">CURRENCY</span>: ' + pixelDict["CURRENCY"]+'<br/>';
            }
					
				
            if(pixelDict["DISCOUNT"] != undefined){
            itemList = itemList + '<span class="params">DISCOUNT</span>: ' + pixelDict["DISCOUNT"]+'<br/>';
            subTotal = subTotal - parseFloat(pixelDict["DISCOUNT"]);
            }
			
            itemList = itemList + '<hr/>';
			
			
            for(var n = 1; n < 100 + 1; n++){
				
            if(pixelDict["ITEM"+n] != undefined){
                
                //TODO add checks for all the other item-style params too
                if(tagType == "simple"){
                    warnings += '<br/>Warning: tag has both AMOUNT and ITEM params';
                    warnings += '<br/>The subtotal will not be calculated for this reason.';
                    badSubtotal = true;
                }
                
                //TODO - check ITEM+n, AMT+n, and QTY+n for the following:
                //does another one exist like two AMT1? that would need to be further up in the flow
                //does the value previous exist, i.e. for ATM2, does AMT1 exist?
                //for AMT1, AMT0 should NOT exist :>
       
                
                //match anything that is not dash, underscore, alphanumeric
                itemBadChars = pixelDict["ITEM"+n].match(/[^0-9A-Z\-_]/gi);

                if(itemBadChars != null){
                    warnings += '<br/>Warning: Illegal characters found in ITEM'+n+': ' + itemBadChars;
                }
                
                
                itemList = itemList + '<br/>'+
                 '<span class="params_head">SKU GROUP NUMBER: '+n +'</span><br/>'+
                 '<span class="params">ITEM'+'</span>: ' + pixelDict["ITEM"+n]+'<br/>'+
                 '<span class="params">AMT'+'</span>: ' + pixelDict["AMT"+n] +'<br/>'+
                 '<span class="params">QTY'+'</span>: ' + pixelDict["QTY"+n] +'<br/>';

              
                //match anything that is not a number
                qtyBadChars = pixelDict["QTY"+n].match(/[^0-9]/g);

                if(qtyBadChars != null){
                    warnings += '<br/>Warning: Illegal characters found in QTY'+n+': ' + qtyBadChars;
                    badSubtotal = true;
                }
	
					
		subTotal = subTotal + parseFloat(pixelDict["AMT"+n]) * parseFloat(pixelDict["QTY"+n]);
					
		if(pixelDict["DCNT"+n] != undefined){
                    itemList = itemList + '<span class="params">DCNT</span>: ' + pixelDict["DCNT"+n]+'<br/>';
                    subTotal = subTotal - parseFloat(pixelDict["DCNT"+n])
		}
            }   else { 	
                
                    //TODO this is meant to stop normally when the array ends, 
                    //but note that it will stop if there is any break in the ITEMx 
            
                    break; }
			
            }
			
			
            //show a warning if the subtoal is suspect
            if(badSubtotal == true){
                                
                warnings += '<br>Warning: Fields used in the order subtotal generated errors. The subtotal may be incorrect.';
            }
                        
				
                $("#output_area").append('<hr/><span class="header">Standalone Pixel Parser</span><hr/>'
                    + warnings + '<br/><br/></div>'
                    +'Order subtotal: ' + subTotal + '<br/><br/>'
                    +'<span class="params">CID</span>: ' + pixelDict["CID"] + '<br/>' 
                    +'<span class="params">TYPE</span>: ' + pixelDict["TYPE"] + '<br/>'
                    +'<span class="params">OID</span>: '+ pixelDict["OID"] + '<br/>'
                    + itemList 
                    +'</div></div><hr/>');


                //only toggle the area if it's hidden already, otherwise it gets hidden 
                
                if( $( "#output_area" ).is( ":hidden" ) ) {
                    
                    $( "#output_area" ).toggle( "slide","500" );    
                    
                }
                

                
														  
                //old - used for popup
                //$(".pop").css("top", e.pageY).css("left", e.pageX - $(".pop").width());
                //$(".pop").slideFadeToggle();
                //$(".pop").draggable({ cancel: "div.info" });	


                //TODO - is it best practice to have this? was in old version
                //return false;
                
		}
);


//this is from when the code was delivered in a popup
//will keep this in case want to do that again later
/*
    $(function() {
        $(".close").live('click', function() {
            $(".pop").slideFadeToggle();
            $(".messagepop").remove();
            return false;
        });
    });

    $.fn.slideFadeToggle = function(easing, callback) {
        return this.animate({ opacity: 'toggle', height: 'toggle' }, "fast", easing, callback);
};
*/	
</script>



</body>

</html>
   





